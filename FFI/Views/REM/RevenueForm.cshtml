@{
    ViewBag.Form = "Revenue";
    Layout = "~/Views/Shared/FormViewLayout1.cshtml";
}

<form id="Revenue_form" class="form-horizontal" data-role="validator" novalidate="novalidate">
    <div class="panel panel-default">
        <div class="panel-body" style="padding-top:6px;padding-bottom:2px">
            <div class="row" style="padding-bottom:15px">
                <div class="col-sm-4">
                    <div class="form-group">
                        <label for="revenue_id" class="col-sm-4 control-label required">Revenue ID:</label>
                        <div class="col-sm-6">
                            <input type="text" id="revenue_id" name="IOU_revenue_id" class="form-control" maxlength="30" readonly>
                        </div>
                    </div>
                </div>
                <div class="col-sm-4">
                    <div class="form-group">
                        <label for="cmb_finyear" class="col-sm-5 control-label required">Financial Year:</label>
                        <div class="col-sm-6">
                            <input id="cmb_finyear" name="In_financial_year_code" style="width: 100%">
                        </div>
                    </div>
                </div>
                <div class="col-sm-4">
                    <div class="form-group">
                        <label for="business_code" class="col-sm-5 control-label required">Business</label>
                        <div class="col-sm-6">
                            <input id="cmb_business" name="In_business_code" style="width: 100%">
                        </div>
                    </div>
                </div>
                <div class="row" style="padding-bottom: 15px;position: absolute;padding-top: 60px;">
                    <div class="col-sm-4" style="padding-left:0px">
                        <label class=" control-label required" id="Uploadlbl" style="margin-left: 34px;position: absolute;">Upload:</label>
                        <div class="col-sm-4" style="margin-left: 185px;">
                            <input type="file" id="fileUpload" disabled />
                            @* <input type="button" id="upload" value="Upload" />*@
                            @*</div>
                                <div class="col-sm-4" style="padding-left:202px;margin-left: -283px;margin-top: 19px;">*@

                            <input type="button" id="upload" value="Upload" disabled />
                        </div>
                    </div>
                    <div class="col-md-4" style="display:none">
                        <div class="form-group">
                            <label for="cmbMenu" class="col-sm-5 control-label" style="padding-right:0px">Upload Screen Name:</label>
                            <div class="col-sm-7">
                                <input id="cmbMenu" name="cmbMenu" data-role="filtercombo" style="width :100%" />
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-2" id="upld" style="left: 176px;">
                        @*  <input id="btn_download_template"  type="button" value="Download Template" />*@
                        <button title="" id="refresh" data-placement="top" data-toggle="tooltip" class="btn btn-info" type="button"
                                data-original-title="Download">
                            <span>Download Template</span>
                        </button>
                        <a id="download_exl_template" download href=""></a>
                    </div>
                </div>
                @*<input type="file" id="fileUpload" />
                    <input type="button" id="upload" value="Upload" />

                    <div id="dvExcel"></div>*@

                @*<div class="col-sm-8" style="padding-left:0px">
                        <label class=" control-label required" style="margin-left: -377px;margin-top: 13px;">Upload:</label>
                        <div class="col-sm-4" style="padding-left:18px;margin-left: -283px;margin-top: 19px;">
                            <input type="file" id="FileUpload1" oncontextmenu="return false" ondrop="return false"  />
                            <input type="button" id="Submit" name="Submit" value="Submit" />
                        </div>
                    </div>*@
                @*@using (Html.BeginForm("Importexcel", "REM", FormMethod.Post))
                    {
                       <table>
                           <tr><td>Excel file</td><td><input type="file" id="FileUpload1" name="FileUpload1" /></td></tr>
                           <tr><td></td><td><input type="submit" id="Submit" name="Submit" value="Submit" /></td></tr>
                       </table>
                    }*@

                <div class="row" style="padding-bottom:15px">
                    <div class="col-sm-4" style="display:none">
                        <div class="form-group">
                            <label for="current_date" class="col-sm-4 control-label required">Current Date</label>
                            <div class="col-sm-6">
                                <input class="cusDate" data-role='datepicker' id="current_date" data-checkdate-msg="Enter Valid Date" name="valid_until" style="width:100%" />
                                <span data-for='valid' class='k-invalid-msg'></span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row" style="padding-bottom:15px">
                    <div class="col-sm-6">
                        <div class="form-group" style="display:none;">
                            <label for="status_code" class="col-sm-5 control-label">Status_code</label>
                            <div class="col-sm-4">
                                <input type="text" value="A" id="status_code" name="In_status_code" class="form-control" maxlength="10">
                            </div>
                        </div>
                    </div>

                    <div class="col-sm-6">
                        <div class="form-group" style="display:none;">
                            <label for="mode_flag" class="col-sm-5 control-label">Mode</label>
                            <div class="col-sm-4">
                                <input type="text" id="mode_flag" name="In_mode_flag" class="form-control" maxlength="10">
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-6">
                        <div class="form-group" style="display:none;">
                            <label for="row_timestamp" class="col-sm-5 control-label">Timestamp:</label>
                            <div class="col-sm-4">
                                <input type="text" id="row_timestamp" name="In_row_timestamp" class="form-control" maxlength="10">
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-6">
                        <div class="form-group" style="display:none;">
                            <label for="revenue_rowid" class="col-sm-5 control-label ">Exp row id:</label>
                            <div class="col-sm-4">
                                <input type="text" id="revenue_rowid" name="IOU_revenue_rowid" class="form-control" maxlength="10">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row" style="padding-top:10px; padding-bottom:10px;display:none">
                    <div class="col-sm-12">
                        <label>Upload History</label>
                        <div id="excel_history_grid"></div>
                    </div>
                </div>
                <div class="row" style="padding-bottom:15px; margin-top: 51px;">
                    <div class="col-xs-12">
                        <div id="revenue_grid">
                            <input type="hidden" id="arycol" />
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>

<script>
    click_act_name = "RevenueList";
    click_ctrl_name = "REM";
    form_list_url = '../' + click_ctrl_name + '/' + click_act_name;
</script>
@*<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>*@
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.13.5/xlsx.full.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.13.5/jszip.js"></script>

<script src="~/API_Scripts/uploadExcelScalar_Model.js"></script>
<script src="~/API_Scripts/uploadExcelVector_Model.js"></script>
<script src="~/API_Scripts/Excel_Template_retrieveExcelTemplate_APIClient.js"></script>
<script src="~/API_Scripts/Excel_Template_saveExcelHistoryLog_APIClient.js"></script>
<script src="~/API_Scripts/Excel_Template_uploadExcelScaler_APIClient.js"></script>
<script src="~/API_Scripts/Excel_Template_uploadExcelVector_APIClient.js"></script>
<script src="~/API_Scripts/retrieveExcelTemplate_Model.js"></script>
<script src="~/API_Scripts/saveExcelHistoryLog_Model.js"></script>
@*<script src="~/API_Scripts/Excel_Template.js"></script>*@
<script src="~/API_Scripts/Excel_Rev_template.js"></script>
<script src="~/API_Scripts/revenue.js"></script>
<script src="~/API_Scripts/Revenue_Master_getRevenue_APIClient.js"></script>
<script src="~/API_Scripts/Revenue_Master_getRevenueList_APIClient.js"></script>
<script src="~/API_Scripts/Revenue_Master_saveRevenue_APIClient.js"></script>
<script src="~/API_Scripts/saveRevenue_Model.js"></script>
<script src="~/API_Scripts/getRevenue_Model.js"></script>
<script src="~/API_Scripts/getRevenueList_Model.js"></script>
<script src="~/API_Scripts/UmoldITWebAPIProxy.js"></script>
<script type="text/javascript">
    $(document).ready(function () {
        var rows = $('#revenue_grid tbody tr');

        $("body").on("click", "#upload", function () {
            //Reference the FileUpload element.
            var fileUpload = $("#fileUpload")[0];

            //Validate whether File is valid Excel file.
            var regex = /^([a-zA-Z0-9\s_\\.\-:])+(.xls|.xlsx)$/;
            if (regex.test(fileUpload.value.toLowerCase())) {
                if (typeof (FileReader) != "undefined") {
                    var reader = new FileReader();

                    //For Browsers other than IE.
                    if (reader.readAsBinaryString) {
                        reader.onload = function (e) {
                            ProcessExcel(e.target.result);
                        };
                        reader.readAsBinaryString(fileUpload.files[0]);
                    } else {
                        //For IE Browser.
                        reader.onload = function (e) {
                            var data = "";
                            var bytes = new Uint8Array(e.target.result);
                            for (var i = 0; i < bytes.byteLength; i++) {
                                data += String.fromCharCode(bytes[i]);
                            }

                            ProcessExcel(data);
                        };
                        reader.readAsArrayBuffer(fileUpload.files[0]);
                    }
                } else {
                    kendoAlert("This browser does not support HTML5.");
                }

            } else {
                kendoAlert("Please upload a valid Excel file.");
            }


        });


        function kndis() {
            var len = $("#revenue_grid").find("tbody tr").length;
            for (var i = 0; i <= len ; i++) {
                var model = $("#revenue_grid").data("kendoGrid").dataSource.at(i);
                if (model) {//field names
                    model.fields["revenuedtl_rowid"].editable = false;
                    model.fields["trn_date"].editable = false;
                    model.fields["revenue_head"].editable = false;
                    model.fields["revenue_desc"].editable = false;
                    model.fields["bill_no"].editable = false;
                    model.fields["revenue_amount"].editable = false;
                    model.fields["status_code"].editable = false;
                    model.fields["mode_flag"].editable = false;


                }

            }

            var rows = $('#revenue_grid tbody tr');
            $.map(rows, function (row) {
                //cell buttons index
                row.cells[0].innerHTML = "";

            });

            $("#revenue_grid .k-grid-toolbar").hide();
        }
        function ProcessExcel(data) {

            //Read the Excel File data.
            var workbook = XLSX.read(data, {
                type: 'binary'
            });
            RevenueGrid([]);
            //Fetch the name of First Sheet.
            var firstSheet = workbook.SheetNames[0];
            //XLSX.utils.format_cell(workbook.Sheets.SheetJS.C1);

            //Read all rows from First Sheet into an JSON array.
            var excelRows = XLSX.utils.sheet_to_row_object_array(workbook.Sheets[firstSheet]);
            console.log(excelRows);
            //var exgrdbnd = JSON.parse(excelRows);
            RevenueGrid(excelRows)
            kndis();

        };
        //function save_disable() {

        //    $('#divUserRole24 #btngen').hide();
        //}

        //$(document).on('click', '#btngen', function (e) {

        //    var C_fy = $('#cmb_finyear').val();
        //    var Cbn = $('#cmb_business').val();
        //    var len = $("#revenue_grid").find("tbody tr").length;
        //    if (C_fy != "" && C_fy != null && Cbn != "" && Cbn != null && len>=0) {
        //        $('#divUserRole24').hide();

        //    }
        //    else {
        //        $('#divUserRole24').show();
        //        return false;
        //    }
        //});
        @*</script>

<script>*@

        $("#cmbMenu").empty();

        list_in = grid_comboScreen_mastercodes("TEMPLATE");
        filter_combobox("cmbMenu", list_in);
        Form_validate_Name = $('form.form-horizontal').attr('id');
        var container = $("#Revenue_form");
        kendo.init(container);
        container.kendoValidator({
        });
        menuload();
        //button enable disable
        $("#divEdit").hide();
        $("#hide_div").hide();
        $("#divCreate").hide();
        $("#bottom_menus").hide();
        $("#divUserRole24").show();
        //$("#current_date").attr("readonly", true);
        var dt = $("#current_date").kendoDatePicker({
            Date: new Date(),
            format: 'dd/MM/yyyy',
        }).data("kendoDatePicker");
        $("#current_date").attr("readonly", true);


        $(".file_attach").attr("hdrtitle", "Revenue");
        $(".notes").attr("hdrtitle", "Revenue");
        $("#lblForm_menuid").text("Revenue");

        Screen_Id = "REVENUE";
        permission = sec_Permission(Screen_Id);
        load_master_code();
        debugger;
        var business = "";
        $("#cmb_business").empty();
        business = grid_comboScreen_mastercodes("QCD_BUSSACTY");
        filter_combobox("cmb_business", business);

        var fin_year = "";
        $("#cmb_finyear").empty();
        fin_year = grid_comboScreen_mastercodes("Finyr");
        filter_combobox("cmb_finyear", fin_year);
        $("#cmb_finyear_listbox").prop("disabled", true);
        $('#cmb_finyear option[value="2020-2021"]').remove();
        $('#cmb_finyear_listbox option[value="2018-2019"]').css("colour", "red");
        $("#financial_year_code_input option[value='2020-2021']").remove();
        
       
        //var ds = $('#cmb_business').data().kendoComboBox.dataSource;

        //someIndex is the index of the item in the dataSource
        // ds.data()[0].prop('disabled', true);

        $('#cmb_finyear').on('change', function () {
            var fnclyr = $("#cmb_finyear").val();
            $('#cmb_finyear option[value="' + fnclyr + '"]').prop("disabled", true);
            var d = new Date();
            var n = d.getFullYear();
            var e = getCurrentFinancialYear();
            console.log(e);
            var sbfn = fnclyr.substring(6, 9);
        });
        function get_code_to_desc(id) {
            try {
                var mat_desc = "";
                var data_source = $('#' + id).data("kendoComboBox");
                data_source = data_source.dataSource._data;
                var cmb_value = $("#" + id).data("kendoComboBox").value();
                $.each(data_source, function (key, val) {
                    var deseription = data_source[key];
                    if (data_source[key].code.toString() == cmb_value.toString()) {
                        mat_desc = data_source[key].desc.toString();
                        return false;
                    }
                });
                return mat_desc;
            }
            catch (err) {
                alert(err);
            }
        }
        var aryup = "";
        aryup = grid_comboScreen_mastercodes("QCD_BUSS_rev");
        console.log(aryup);
        $('#refresh').click(function () {
            //alert("s")
            //     if ($("#cmbMenu").val() == "") {
            //         kendoAlert("Please Select a menu.");
            //         return false;
            //     //}



            $("#fileUpload").prop("disabled", false);
            $("#upload").prop("disabled", false);
            var xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function () {
                if (xhr.readyState == 4 && xhr.status == 200) {
                    var result = JSON.parse(xhr.responseText);
                    if (result.msg != undefined)
                        kendoAlert(result.msg);
                    else {
                        if (result.path != undefined) {
                            var url_path = result.path;
                            $("#download_exl_template").attr("href", url_path);
                            document.getElementById("download_exl_template").click();
                        }
                    }
                }
            };

            var col_name = ex_colname();
            var fd = new FormData();
            fd.append("template_name", exl_tmp_name());
            fd.append("column_name", JSON.stringify(col_name));
            fd.append("array_upload", JSON.stringify(aryup));
            xhr.open("POST", "/REM/Excel_Template", true);
            xhr.send(fd);
            xhr.addEventListener("load", function (event) {
            }, false);

        });
        //function download_Excel_template() {
        //    if ($("#cmbMenu").val() == "") {
        //        kendoAlert("Please Select a menu.");
        //        return false;
        //    }
        //    var xhr = new XMLHttpRequest();
        //    xhr.onreadystatechange = function () {
        //        if (xhr.readyState == 4 && xhr.status == 200) {
        //            var result = JSON.parse(xhr.responseText);
        //            if (result.msg != undefined)
        //                kendoAlert(result.msg);
        //            else {
        //                if (result.path != undefined) {
        //                    var url_path = result.path;
        //                    $("#download_exl_template").attr("href", url_path);
        //                    document.getElementById("download_exl_template").click();
        //                }
        //            }
        //        }
        //    };

        //    var col_name = ex_colname();
        //    var fd = new FormData();
        //    fd.append("template_name", exl_tmp_name());
        //    fd.append("column_name", JSON.stringify(col_name));
        //    xhr.open("POST", "/REM/Excel_Template", true);
        //    xhr.send(fd);
        //    xhr.addEventListener("load", function (event) {
        //    }, false);
        //}
        function getCurrentFinancialYear() {
            var fiscalyear = "";
            var today = new Date();
            if ((today.getMonth() + 1) <= 3) {
                fiscalyear = (today.getFullYear() - 1) + "-" + today.getFullYear()
            } else {
                fiscalyear = today.getFullYear() + "-" + (today.getFullYear() + 1)
            }
            return fiscalyear
        }

        RevenueGrid([]);
        if (getlocalStorage('btn_clk_val') == "Create") {
            $('#divCreate #review').hide();
            $("#txtMode").val("I");
            $("#bottom_menus").hide();
            $("#DocStat").val("New");


        }
        else if (getlocalStorage('btn_clk_val') == "View" || getlocalStorage('btn_clk_val') == "Edit") {
            $('#divEdit #reviewEd').hide();
            $('#refresh').hide();
            $('#fileUpload').hide();
            $('#upload').hide();
            $('#Uploadlbl').hide();
            if (getlocalStorage("ls_pageList") != undefined) {
                var data = getlocalStorage("ls_pageList");
                var formval = form_Serialize("Revenue_form");
                var obj_val = JSON.parse(formval);
                debugger;
                obj_val.revenue_rowid = data.Out_revenue_rowid;
                //   obj_val.revenue_code = data.revenue_code;
                obj_val.revenue_id = data.Out_revenue_id;
                var data = {};
                data.context = WebAPIProxy.getContext();
                data.context.Header = obj_val;  

                var Context = data.context;
                $.ajax({
                    type: "POST",
                    data: JSON.stringify({ userId: Context.userId, orgnId: Context.orgnId, locnId: Context.locnId, localeId: Context.localeId, revenue_rowid: Context.Header.revenue_rowid, revenue_id: Context.Header.revenue_id }),
                    url: "/REM/Revenuefetch",
                    dataType: "json",
                    contentType: 'application/json; charset=utf-8',
                    success: function (response) {
                        debugger;
                        if (response.context != null) {
                            debugger;
                            generate_revenue_header(response.context.Header);
                            generate_revenue_detail(response.context.Details);
                            //SetPager(response.context.Filter.out_record_count)
                        }
                        else {
                            grid_role([]);
                        }
                    },
                    error: function (er) {
                        alert(er)
                        console.log(er)
                    }

                });

               // retrieve_Revenue_details(data);
                $("#txtMode").val("U");
            }
        }

       
        function menuload() {
            $("#btn_download_template").attr("disabled", false);
            $("#btn_upload").attr("disabled", false);
            $("#FileUpload1").attr("disabled", false);
            $("#FileUpload1").val('');
            var formval = form_Serialize("Revenue_form");
            var obj_val = JSON.parse(formval);
            obj_val.excel_upload_code = "REV";
            var data = {};
            data.context = WebAPIProxy.getContext();
            data.context.Header = obj_val;
           // retrieve_Excel_Template_list(data);
        }
        //$("#cmbMenu").change(function (evt) {
        //    var menu_id = $('#cmbMenu').data("kendoComboBox").value();//$("#cmbMenu").val();
        //    if (menu_id != "") {
        //        $("#btn_download_template").attr("disabled", false);
        //        $("#btn_upload").attr("disabled", false);
        //        $("#FileUpload1").attr("disabled", false);
        //        $("#FileUpload1").val('');
        //        var formval = form_Serialize("Revenue_form");
        //        var obj_val = JSON.parse(formval);
        //        obj_val.excel_upload_code = menu_id;
        //        var data = {};
        //        data.context = WebAPIProxy.getContext();
        //        data.context.Header = obj_val;
        //        retrieve_Excel_Template_list(data);
        //    }
        //    //else {
        //    //    var data = [];
        //    //    historyGrid(data);
        //    //}
        //});

        //function historyGrid(data) {
        //    try {
        //        $("#excel_history_grid").kendoGrid({
        //            dataSource: {
        //                data: data,
        //            },
        //            height: 300,
        //            selectable: true,
        //            scrollable: true,
        //            columns: [
        //                 {
        //                     field: "excel_upload_code",
        //                     title: "Excel Upload Code",
        //                     hidden: true,
        //                     width: 100

        //                 },
        //                {
        //                    field: "excel_filename",
        //                    title: "Excel Filename",
        //                    width: 100

        //                },
        //                {
        //                    field: "status_code",
        //                    title: "Status",
        //                    hidden: true,
        //                    width: 100
        //                },
        //                 {
        //                     field: "status_desc",
        //                     title: "Status",
        //                     width: 100

        //                 },
        //                 {
        //                     field: "uploaded_by",
        //                     title: "Uploaded by",
        //                     width: 100
        //                 },
        //                   {
        //                       field: "uploaded_datetime",
        //                       title: "Uploaded Date Time",
        //                       width: 100
        //                   },
        //            ]
        //        });
        //    }
        //    catch (err) {

        //    }
        //}

        //function generate_Excel_Template_history(res) {
        //    if (res == null) {
        //        historyGrid([]);
        //    }
        //    else {
        //        var data = changedataType(res);
        //        historyGrid(data);
        //    }

        //}

        //var entity_gcode = "";
        //var no_columns = "";
        //var proc_name = "";
        //var proc_type = "";

        //function generate_Excel_Template_Header(res) {
        //    debugger;
        //    entity_gcode = res.entity_group_code;
        //    setlocalStorage("entity_groupcode", entity_gcode)
        //    no_columns = res.no_of_columns;
        //    proc_name = res.procedure_name;
        //    proc_type = res.procedure_type;

        //    setlocalStorage("procedure_type", proc_type)
        //}

        //function generate_Excel_Template_Column(res) {
        //    debugger;
        //    removelocalStorage("excel_fetch_column");
        //    setlocalStorage("excel_fetch_column", res)
        //}

        function ex_colname() {
            var colname = getlocalStorage("excel_fetch_column");
            return colname;
        }


        function exl_tmp_name() {
            //var menu_id = get_code_to_desc("cmbMenu");
            //tmp_name = menu_id + "_template";
            tmp_name = "Revenue Details_template";
            return tmp_name;
        }

    });

   
</script>

<script>
    function load_master_code() {
        try {
            var data = {};
            data.screen_Id = "REVENUE";
            var tab_values = ajaxcall_param("/Home/screenId_mastercodelist", JSON.stringify(data));
        }
        catch (err) {
            javascript_log4j_root(arguments.callee.name, err);
        }
    }
</script>

<script>
    //var data = [];
    function RevenueGrid(data) {
        try {
            $("#revenue_grid").kendoGrid({
                dataSource: {
                    data: data,
                    schema: {
                        model: {
                            fields: { 
                                In_revenuedtl_rowid: { type: "int" },
                                In_trn_date: { type: "date" },
                                In_revenue_head: { type: "string" },
                                In_revenue_desc: { type: "string" },
                                In_bill_no: { type: "string" },
                                In_revenue_amount: { type: "string" },
                                In_status_code: { type: "string" },
                                In_mode_flag: { type: "string" }
                            }
                        }
                    }
                },
                toolbar: "<a class='k-grid-add' id='btnAdd' href=''><span class='fa fa-plus' style='color:Black'></span></a>",
                height: 400,
                groupable: false,
                dataBinding: setDefaultValues,

                dataBound: function (e) {
                    debugger;
                    var grid_val = JSON.stringify($("#revenue_grid").data().kendoGrid._data);
                    var Bind = {};

                    Bind = grid_val;
                    var result = JSON.parse(Bind);
                    $.each(result, function (index, value) {
                        var Date = value.trn_date;
                        var RevHeader = value.revenue_head;
                        var RevDesc = value.revenue_desc;
                        var BillNO = value.bill_no;
                        var RevAmount = value.revenue_amount;
                        var mode = value.mode_flag;
                        if (RevHeader == "" && RevHeader == null) {
                            $("#revenue_grid").find(".k-toolbar").hide();
                            $(".k-grid-add", "#revenue_grid").hide();
                        }



                    });
                    resultData = e.sender._data;
                    var rows = $('#revenue_grid').data('kendoGrid').tbody.children();
                    setColor(rows, resultData);
                },
                edit: OnEdit,
                sortable: false,
                selectable: false,
                navigatable: true,
                columns: [{
                    command: [
                          {
                              name: "Delete",
                              id: "Delete",
                              imageClass: "fa fa-close",
                              click: function (e) {
                                  // e.preventDefault();
                                  var grid = $("#revenue_grid").data("kendoGrid");
                                  var dataItem = $("#revenue_grid").data("kendoGrid").dataItem($(e.target).closest("tr"));
                                  //dataItem.mode_flag = "S";
                                  DeleteWindowEvent(e, dataItem, grid);
                                  e.stopImmediatePropagation()
                              }
                          },
                    ], title: "Action", width: "50px",
                },
            //{
            //    name: "Delete",
            //    id: "Delete",
            //    imageClass: "fa fa-close",
            //    click: function (e) {
            //        // e.preventDefault();
            //        var grid = $("#revenue_grid").data("kendoGrid");
            //        var dataItem = $("#revenue_grid").data("kendoGrid").dataItem($(e.target).closest("tr"));
            //      // dataItem.mode_flag = "S";
            //        DeleteWindowEvent(e, dataItem, grid);
            //        e.stopImmediatePropagation()
            //    }
            //},
            //        ], title: "&nbsp;", width: "10px",
            //    },
                    {
                        field: "In_revenuedtl_rowid",
                        title: "revenuedtl_rowid",
                        width: 1,
                        hidden: true,
                    },
                    {
                        field: "In_trn_date",
                        title: "Transaction Date",
                        width: 50,
                        format: "{0:dd/MM/yyyy}"
                        //template: '#= kendo.toString(kendo.parseDate(trn_date), "dd/MM/yyyy")#'
                    },
                    {
                        field: "In_revenue_head",
                        title: "Revenue Head",
                        width: 80,
                        editor: function (container, options) {
                            combo_editor_man(container, "cmb_" + options.field, eval(options.field + "_list"), options.field, "In_businessactivity_code", "revenue_grid")
                        },
                    },
                    {
                        field: "In_revenue_desc",
                        title: "Revenue Description",
                        width: 120
                        //editor: function (container, options) {
                        //    $('<input type="text" class="k-input k-textbox" onkeypress="return isValidChar(event)">')
                        //        .appendTo(container);
                        //},
                        //editor: function (container, options) {
                        //    combo_editor_man(container, "cmb_" + options.field, eval(options.field + "_list"), options.field, "businessactivity_code", "FPOExpenses_grid")
                        //},
                    },
                    //{
                    //    field: "revenue_or_billno",
                    //    title: "Revenue/Bill No",
                    //    width: 80,
                    //},
                    {
                        field: "In_bill_no",
                        title: "Revenue/Bill No",
                        width: 80,
                    },
                    {
                        field: "In_revenue_amount",
                        title: "Amount",
                        width: 100,
                        attributes: { style: "text-align:right;" },
                        editor: function (container, options) {
                            item_rate(container, options.field, '9', '2');
                        },
                    },
                    {
                        field: "In_status_code",
                        title: "status_code",
                        hidden: true,
                        width: 100,
                    },
                    {
                        field: "In_UploadStatus",
                        title: "UploadStatus",
                        hidden: true,
                        width: 100,
                    },
                    {
                        field: "In_Comments",
                        title: "Comments",
                        hidden: true,
                        width: 100,
                    },
                    {
                        field: "In_mode_flag",
                        title: "Mode",
                        hidden: true
                    }],
                editable: true
            });
        }
        catch (err) {
            alert(err);
        }
    }
    load_master_code();

    In_revenue_desc_list = grid_comboScreen_mastercodes("QCD_BUSS_rev");
    In_revenue_head_list = grid_comboScreen_mastercodes("QCD_BUSS_rev");
    expensehead_desc_list = grid_comboScreen_mastercodes("QCD_FPO_EXPHEAD");
    status_desc_list = grid_comboScreen_mastercodes("STATUS");

    function OnEdit(e) {
        setDefaultValues(e);
        e.container.find("input[name='In_expense_amount']").focusout(function () {

            var grid = $("#FPOExpenses_grid").data("kendoGrid");
            var gridData = grid.dataSource.view();
            var EXP_rate = 0;
            for (var i = 0; i < gridData.length; i++) {
                if (gridData[i].rating != '') {
                    EXP_rate += gridData[i].In_expense_amount != undefined ? parseFloat(gridData[i].In_expense_amount) : parseFloat(0);
                }
            }
            $('#txttotalexpence').val(EXP_rate).toFixed(2);

        });
    }
</script>

<script>
    function save() {
        try {
            debugger;
            var C_fy = $('#cmb_finyear').val();
            var Cbn = $('#cmb_business').val();
            var len = $("#revenue_grid").find("tbody tr").length;
            var finflag = 0;
            var trnflag = 0;
            var isflag = 0;
            var delflag = 0;
            var trndate = '';
            //if (C_fy != "" && C_fy != null && Cbn != "" && Cbn != null && len >0) {
            //    $('#divUserRole24 #btngen').hide();

            //}
            //else {
            //    $('#divUserRole24 #btngen').show();
            //    return false;
            //}

            var billno = ""
            if ($("#revenue_rowid").val() == "") {
                $("#revenue_rowid").val('0');
            }
            if ($("#revenue_id").val() == "") {
                $("#revenue_id").val('');
            }
            if ($("#row_timestamp").val() == "") {
                $("#row_timestamp").val('0');
            }
            if ($("#mode_flag").val() == "") {
                $("#mode_flag").val('I');
            }
            if ($("#mode_flag").val() == "S") {
                $("#mode_flag").val('U');
            }
            if ($("#DocStat").val() == "Active" && $("#mode_flag").val() != "D") {
                $("#mode_flag").val('U');
            }
            var formval = form_Serialize("Revenue_form");
            var obj_val = JSON.parse(formval);
            var grid_val = JSON.stringify($("#revenue_grid").data().kendoGrid._data);
            var Bind = {};

            Bind = grid_val;
            var result = JSON.parse(Bind);
            $.each(result, function (index, value) {
                debugger;
                var flyr = value.In_trn_date; //getFormated_StringDate 

                var revdes = value.In_revenue_desc;
                var revhd = value.In_revenue_head;
                var revblno = value.In_bill_no;
    
                //if ((value.In_trn_date == null) || (value.In_trn_date == "")) {
                //    var d1 = new Date();
                //    var date1 = kendo.parseDate(d1);
                //    trndate = kendo.toString(date1, "MM/dd/yyyy");
                //    value.In_trn_date = trndate
                //}
                //else {
                //    var d = value.In_trn_date;
                //    var date = kendo.parseDate(d);
                //    trndate = kendo.toString(date, "MM/dd/yyyy");
                //    value.In_trn_date = trndate;
                //}

                value.In_trn_date = value.In_trn_date.replace('Z','').replace('z','').trim();
               
                //  var amount = value.revenue_amount;
                if (flyr != "" && flyr != null && revdes != "" && revdes != null && revhd != "" && revhd != null && revblno != "" && revblno != null) {
                    //if( (/^[a-zA-Z]+$/.test(value.revenue_desc)) ==false){
                    //    kendoAlert("Please Enter a valid description!!!!");
                    //    return false;
                    //}
                    if ((/^[0-9]+([.][0-9]+)?$/g.test(value.In_revenue_amount)) == false) {
                        kendoAlert("Please Enter a Revenue Amount!!!!");
                        isflag = 1;
                        return false;
                    }
                    var month = flyr.substring(6, 7);

                    var firstyr = C_fy.substring(2, 6);
                    var secyear = C_fy.substring(7, 11);
                    var frstyrmnth = "";
                    var arrA = [];
                    var secyrmnth = "";
                    for (var i = 4; i <= 9; i++) {
                        arrA.push(C_fy.substring(2, 6) + "-" + 0 + i);
                    }
                    for (var i = 10; i <= 12; i++) {
                        arrA.push(C_fy.substring(2, 6) + "-" + i);
                    }
                    for (var i = 1; i <= 3; i++) {
                        arrA.push(C_fy.substring(7, 11) + "-" + 0 + i);
                    }

                    for (var j = 0; j < arrA.length; j++) {

                        if (arrA[j] == flyr.substring(0, 7)) {

                            var row_id = value.In_revenuedtl_rowid;
                            if (row_id == undefined || row_id == "") {
                                result[index].In_revenuedtl_rowid = "0";
                                result[index].In_mode_flag = "I";
                            }
                            billno = value.In_bill_no;
                            var timestamp = value.In_row_timestamp;
                            if (timestamp == undefined || timestamp == "") {
                                result[index].In_row_timestamp = "0";
                            }
                            var status_code = value.In_status_code;
                            if (status_code == undefined || status_code == "") {
                                result[index].In_status_code = "A";
                            }
                            if (status_code == "S") {
                                result[index].In_status_code = "U";
                            }

                            var mode_flag = value.In_mode_flag;
                            if (mode_flag == undefined || mode_flag == "") {
                                result[index].In_mode_flag = "I";
                            }
                            if ($("#DocStat").val() == "Active" && result[index].In_revenuedtl_rowid != 0 && result[index].In_mode_flag != "D") {
                                result[index].In_mode_flag = "U";
                            }
                                //if ($("#DocStat").val() == "Active" && result[index].revenuedtl_rowid == 0 && result[index].mode_flag != "D") {
                                //    result[index].mode_flag = "UI";
                                //}
                            else if (result[index].In_mode_flag == "D") {
                                result[index].In_mode_flag = "D";
                                delflag = delflag+1;
                            }
                            else {
                                result[index].In_mode_flag = "I";
                            }
                            finflag = finflag+1;
                            trnflag = 1
                        }



                    }

                }

            });

            if (finflag == len && delflag == 0) {

                if (C_fy != "" && C_fy != null && Cbn != "" && Cbn != null && len > 0) {
                    var obj_grid_val = result;
                    $('#divUserRole24 #btngen').hide();
                    var rows = $('#revenue_grid tbody tr');
                    $.map(rows, function (row) {
                        //cell buttons index
                        row.cells[0].innerHTML = "";

                    });
                    var data = {};
                    data.context = WebAPIProxy.getContext();
                    data.context.Header = obj_val;
                    data.context.Details = obj_grid_val;
                    save_Revenue_details(data);
                    var rows = $('#revenue_grid tbody tr');
                    $.map(rows, function (row) {
                        //cell buttons index
                        row.cells[0].innerHTML = "";

                    });
                    $("#revenue_grid .k-grid-toolbar").hide();
                    // finflag = 1;
                }
            }
            if (delflag == len) {
                kendoAlert("Please Enter atleast one record to save !!!!");
                return false;
            }
            if (finflag == len && delflag >= 1) {
                if (len >= 2) {

                    if (C_fy != "" && C_fy != null && Cbn != "" && Cbn != null && len > 0) {
                        var obj_grid_val = result;
                        $('#divUserRole24 #btngen').hide();
                        var rows = $('#revenue_grid tbody tr');
                        $.map(rows, function (row) {
                            //cell buttons index
                            row.cells[0].innerHTML = "";

                        });
                        var data = {};
                        data.context = WebAPIProxy.getContext();
                        data.context.Header = obj_val;
                        data.context.Details = obj_grid_val;
                        save_Revenue_details(data);
                        var rows = $('#revenue_grid tbody tr');
                        $.map(rows, function (row) {
                            //cell buttons index
                            row.cells[0].innerHTML = "";

                        });
                        $("#revenue_grid .k-grid-toolbar").hide();
                        // finflag = 1;
                    }
                }
                else {
                    kendoAlert("Please Enter atleast one record to save !!!!");
                    return false;
                }
            }
            if (trnflag == 0 && finflag == 0 && isflag == 0) {
                kendoAlert("Please check whether all fields are filled and Financial Year is matched !!!!");
                return false;
            }
            else if (trnflag == 0 && isflag == 0) {
                kendoAlert("Please Enter a valid trn date");
                return false;
            }
            else if (finflag < len && isflag == 0) {

                kendoAlert("Financial Year doesn't match.Revenue details not saved !!!!");
                return false;

            }

            //if (finflag == 0) {
            //    if (C_fy != "" && C_fy != null && Cbn != "" && Cbn != null && len > 0) {
            //        var obj_grid_val = result;
            //        $('#divUserRole24 #btngen').hide();
            //        var rows = $('#revenue_grid tbody tr');
            //        $.map(rows, function (row) {
            //            //cell buttons index
            //            row.cells[0].innerHTML = "";

            //        });
            //        var data = {};
            //        data.context = WebAPIProxy.getContext();
            //        data.context.Header = obj_val;
            //        data.context.Details = obj_grid_val;
            //        save_Revenue_details(data);
            //        var rows = $('#revenue_grid tbody tr');
            //        $.map(rows, function (row) {
            //            //cell buttons index
            //            row.cells[0].innerHTML = "";

            //        });
            //    }
            //    else {
            //        $('#divUserRole24 #btngen').show();
            //        return false;
            //    }
            //}

        }
        catch (err) {
            javascript_log4j_root(arguments.callee.name, err);
        }
    }

    function save_Revenue_details(sdata) {
        var Context = sdata.context;
        $.ajax({
            type: "POST",
            data: JSON.stringify({ userId: Context.userId, orgnId: Context.orgnId, locnId: Context.locnId, localeId: Context.localeId, Header: Context.Header, Details: Context.Details }),
            url: "/REM/REMSave",
            dataType: "json",
            contentType: 'application/json; charset=utf-8',
            success: function (response) {
                console.log(response)
                var Res = JSON.parse(response);
                if (Res.context != null) {
                    console.log(Res);
                    kendoAlert("Saved Succedfully"); debugger;
                    //get_DocNumberActivity_details(Res.context.Header.IOU_revenue_rowid); 
                    //IOU_revenue_id: "REV/0007"
                    //IOU_revenue_rowid:
                    afterIU(Res.context)
                    //generate_revenue_header(Res.context.Header);
                    //generate_revenue_detail(Res.context.Details);
                }
                else {
                    kendoAlert(Res.ApplicationException.errorDescription);
                }
            },
            error: function (er) {
                alert(er)
                console.log(er)
            }

        });
    }
</script>

<script>
    function generate_revenue_header(res) {
        debugger;
        try {
            $("#revenue_rowid").val(res.IOU_revenue_rowid);
            //$("#revenuedtl_rowid").val(res.revenuedtl_rowid);
            $("#revenue_id").val(res.IOU_revenue_id);
            $('#cmb_business').data("kendoComboBox").value(res.In_business_code);
            $('#cmb_finyear').data("kendoComboBox").value(res.In_financial_year);
            $("#DocStat").val(res.In_status_desc);
            $("#txtMode").val(res.In_mode_flag);
            $("#txt_row_timestamp").val(res.In_row_timestamp);
        }
        catch (err) {
            javascript_log4j_root(arguments.callee.name, err);
        }
    }

    function generate_revenue_detail(res) {
        debugger;
        try {
            if (res != null) {
                var data = changedataType(res);

                RevenueGrid(data);
            }
            else {
                RevenueGrid([]);
            }
        }
        catch (err) {
            javascript_log4j_root(arguments.callee.name, err);
        }
    }

    function get_revenue_details(res) {
        debugger;
        try {
            var data = getlocalStorage("ls_pageList");
            var formval = form_Serialize("Revenue_form");
            var obj_val = JSON.parse(formval);
            //$("#revenue_rowid").val(res.revenue_rowid);
            //$("#revenue_id").val(res.revenue_code);
            // $("#revenue_id").val(res.revenue_id);
            if (getlocalStorage("ls_pageList") != undefined) {
                var data = getlocalStorage("ls_pageList");
                var formval = form_Serialize("Revenue_form");
                var obj_val = JSON.parse(formval);
                obj_val.revenue_rowid = res.revenue_rowid;
                obj_val.revenue_code = res.revenue_code;
                obj_val.revenuedtl_rowid = res.revenuedtl_rowid;
                obj_val.revenue_id = res.revenue_id;
                var data = {};
                data.context = WebAPIProxy.getContext();
                data.context.Header = obj_val;
                retrieve_Revenue_details(data);
                $("#txtMode").val("U");
            }
            //obj_val.revenue_rowid = res.revenue_rowid;
            //obj_val.revenuedtl_rowid = res.revenue_id;
            //var data = {};
            //data.context = WebAPIProxy.getContext();
            //data.context.Header = obj_val;
            //retrieve_Revenue_details(data);
            //$("#txtMode").val("U");
        }
        catch (err) {
            javascript_log4j_root(arguments.callee.name, err);
        }
    }

    function afterIU(datas) {
        var Context = datas;
        $.ajax({
            type: "POST",
            data: JSON.stringify({ userId: Context.userId, orgnId: Context.orgnId, locnId: Context.locnId, localeId: Context.localeId, revenue_rowid: Context.Header.IOU_revenue_rowid, revenue_id: Context.Header.IOU_revenue_id }),
            url: "/REM/Revenuefetch",
            dataType: "json",
            contentType: 'application/json; charset=utf-8',
            success: function (response) {
                debugger;
                if (response.context != null) {
                    debugger;
                    generate_revenue_header(response.context.Header);
                    generate_revenue_detail(response.context.Details);
                    //SetPager(response.context.Filter.out_record_count)
                }
                else {
                    grid_role([]);
                }
            },
            error: function (er) {
                alert(er)
                console.log(er)
            }

        });
    }
</script>
